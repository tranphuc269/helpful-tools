// --- BẮT ĐẦU ĐOẠN MÃ ĐÃ SỬA ---

// URL của thư viện jsPDF
const jspdfUrl = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.min.js';

// Tạo thẻ script
const jspdf = document.createElement("script");

// Hàm xử lý sau khi tải xong jsPDF
jspdf.onload = function () {
    // Khởi tạo đối tượng PDF
    let pdf = new jsPDF();
    
    // Lấy tất cả các thẻ <img>
    let elements = document.getElementsByTagName("img");
    
    // Lặp qua từng ảnh
    for (let i in elements) {
        let img = elements[i];
        
        // Chỉ xử lý các ảnh có nguồn là "blob:" (thường là ảnh được hiển thị trong trình xem của Google Drive)
        if (!/^blob:/.test(img.src)) {
            continue;
        }
        
        // Tạo một canvas để vẽ ảnh lên
        let canvasElement = document.createElement('canvas');
        let con = canvasElement.getContext("2d");
        canvasElement.width = img.width;
        canvasElement.height = img.height;
        con.drawImage(img, 0, 0, img.width, img.height);
        
        // Chuyển đổi canvas thành dữ liệu ảnh JPEG
        let imgData = canvasElement.toDataURL("image/jpeg", 1.0);
        
        // Thêm ảnh vào file PDF
        pdf.addImage(imgData, 'JPEG', 0, 0);
        
        // Thêm trang mới cho ảnh tiếp theo
        pdf.addPage();
    }
    
    // Lưu file PDF
    pdf.save("download.pdf");
};

// **PHẦN SỬA LỖI QUAN TRỌNG**
// Kiểm tra xem trình duyệt có yêu cầu Trusted Types hay không
if (window.trustedTypes && window.trustedTypes.createPolicy) {
  // Tạo một chính sách đơn giản để cho phép URL
  const policy = window.trustedTypes.createPolicy('jspdfPolicy', {
    createScriptURL: (url) => url
  });
  // Sử dụng chính sách để tạo một TrustedScriptURL
  jspdf.src = policy.createScriptURL(jspdfUrl);
} else {
  // Nếu không, gán trực tiếp như cũ (cho các môi trường không có CSP nghiêm ngặt)
  jspdf.src = jspdfUrl;
}

// Thêm thẻ script vào trang để tải thư viện
document.body.appendChild(jspdf);

// --- KẾT THÚC ĐOẠN MÃ ĐÃ SỬA ---
